<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>K-Bank Statement Pro - Official Format</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+39&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="css/Steatment.css">

    <script src="lib/qrcode.min.js"></script>
    <script src="lib/jspdf.umd.min.js"></script>
    <script src="lib/html2canvas.min.js"></script>
</head>
<body>

    <nav class="no-print panel-container">
        <button onclick="window.print()" class="print-btn">
            üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Browser)
        </button>
        <button onclick="exportToPDF(event)" class="print-btn pdf-btn">
            üìÑ ‡πÄ‡∏ã‡∏ü PDF (High Quality)
        </button>
        <button onclick="location.href='index.html'" class="print-btn" style="background:#636e72">
            üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        </button>
    </nav>

    <div id="document-wrapper">
        <div id="page-container">
            </div>
    </div>

    <script src="js/Steatment.js"></script>

    <script>
        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code
         * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ container ‡πÅ‡∏•‡∏∞ ref ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á
         */
        function makeQRCodes() {
            const qrContainers = document.querySelectorAll('.qr-code-container');
            qrContainers.forEach((div) => {
                if (div.childNodes.length === 0) {
                    const reference = div.dataset.ref || `KB${Date.now()}`;
                    new QRCode(div, {
                        text: `https://verify.kasikornbank.com/v/${reference}`,
                        width: 100, // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
                        height: 100,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }
            });
        }

        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Export PDF ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°
         * ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Multi-page ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏™‡∏π‡∏á
         */
        async function exportToPDF(event) {
            const btn = event.target;
            const originalText = btn.innerText;
            
            // UI Feedback
            btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
            btn.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                const container = document.getElementById('page-container');
                const pages = container.getElementsByClassName('page');
                
                if (pages.length === 0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£");

                const pdf = new jsPDF('p', 'mm', 'a4');

                for (let i = 0; i < pages.length; i++) {
                    // ‡πÅ‡∏õ‡∏•‡∏á HTML ‡πÄ‡∏õ‡πá‡∏ô Canvas ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏á (Scale 3)
                    const canvas = await html2canvas(pages[i], { 
                        scale: 3, 
                        useCORS: true,
                        allowTaint: false,
                        logging: false,
                        backgroundColor: "#ffffff"
                    });

                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    
                    if (i > 0) pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297, undefined, 'FAST');
                }

                pdf.save(`K-Bank_Statement_${new Date().getTime()}.pdf`);
            } catch (err) {
                console.error(err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF: " + err.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        /**
         * Lifecycle: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
         */
        window.addEventListener('load', () => {
            // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏£‡πâ‡∏≠‡∏°
            setTimeout(() => {
                if (typeof renderApp === 'function') {
                    renderApp(); 
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
                    setTimeout(makeQRCodes, 300);
                } else {
                    console.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderApp ‡πÉ‡∏ô Steatment.js");
                }
            }, 100);
        });
    </script>
</body>
</html>
